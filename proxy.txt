
# Настройка прокси-сервера для приложения "Тонко"

Это руководство описывает, как настроить и развернуть прокси-сервер на платформе Vercel для обхода проблем с CORS при взаимодействии с Google Apps Script.

## Обзор

Прокси-сервер выступает в качестве посредника между вашим веб-приложением и Google Apps Script API, решая проблемы с CORS и обрабатывая запросы и файлы должным образом.

## Шаг 1: Подготовка к развертыванию на Vercel

1. Создайте аккаунт на [Vercel](https://vercel.com/) если его ещё нет
2. Установите Vercel CLI (опционально для локального тестирования):
   ```
   npm i -g vercel
   ```

## Шаг 2: Настройка переменных окружения

В консоли Vercel необходимо настроить переменную окружения:

1. Перейдите в настройки вашего проекта на Vercel
2. Выберите вкладку "Environment Variables"
3. Добавьте переменную:
   - `TARGET_URL` = URL вашего развернутого Google Apps Script Web App
   Пример: `https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec`

## Шаг 3: Развертывание прокси на Vercel

### Вариант 1: Развертывание через GitHub

1. Создайте репозиторий на GitHub
2. Загрузите файлы из папки `proxy` в репозиторий:
   - `index.js`
   - `package.json`
   - `vercel.json`

3. На платформе Vercel:
   - Нажмите "Add New" > "Project"
   - Выберите свой репозиторий
   - Настройте переменные окружения как описано в Шаге 2
   - Нажмите "Deploy"

### Вариант 2: Развертывание через Vercel CLI

1. Перейдите в папку с файлами прокси
   ```
   cd proxy
   ```

2. Авторизуйтесь в Vercel CLI
   ```
   vercel login
   ```

3. Разверните проект
   ```
   vercel
   ```

4. Следуйте инструкциям мастера развертывания. Когда вас спросят о переменных окружения, добавьте `TARGET_URL`.

5. После завершения тестового развертывания, разверните в production:
   ```
   vercel --prod
   ```

## Шаг 4: Обновление URL в приложении

После того как ваш прокси развернут на Vercel, обновите константу `API_BASE_URL` в файле `src/services/api.ts`:

```typescript
const API_BASE_URL = 'https://your-vercel-app-name.vercel.app/api';
```

## Тестирование прокси

1. Отправьте тестовый GET-запрос:
   ```
   curl "https://your-vercel-app-name.vercel.app/api?action=getEmployees"
   ```

2. Проверьте журналы в панели управления Vercel для отладки проблем

## Устранение неисправностей

### Проблемы с CORS
- Убедитесь, что ваш прокси корректно настроен для обработки запросов CORS
- Проверьте, что в `vercel.json` правильно настроены маршруты

### Проблемы с загрузкой файлов
- Убедитесь, что `multer` корректно настроен
- Проверьте, что файлы правильно добавляются в FormData

### Ошибки авторизации
- Если для доступа к Google Apps Script требуется аутентификация, добавьте необходимую логику в прокси

## Ограничения бесплатного тарифа Vercel

- Ограничение на количество запросов в месяц
- Ограничение на размер загружаемых файлов
- Без гарантии высокой доступности

Для продакшн-среды с высокой нагрузкой рекомендуется перейти на платный тариф.

## Обновление прокси

При необходимости обновить код прокси:

1. Внесите необходимые изменения в код
2. Загрузите изменения в GitHub (при использовании варианта 1)
3. Или выполните `vercel --prod` (при использовании варианта 2)
